
const express = require('express');
const multer = require('multer');
const cors = require('cors');
const cloudinary = require('cloudinary').v2;
const { CloudinaryStorage } = require('multer-storage-cloudinary');

const app = express();
const PORT = process.env.PORT || 3000;

// Abilita CORS solo dal dominio frontend Netlify
app.use(cors({
  origin: 'https://negriundermyskinphotoalbum.netlify.app'
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Configura Cloudinary
cloudinary.config({
  cloud_name: 'dgrsbjjqw',
  api_key: '467979564625165',
  api_secret: 'OhsSTdKlBYyrnFzg2K6XqnOgdzw'
});

// Configura storage Cloudinary per multer
const storage = new CloudinaryStorage({
  cloudinary: cloudinary,
  params: {
    folder: 'galleria-profili',
    allowed_formats: ['jpg', 'jpeg', 'png']
  }
});

const upload = multer({ storage });

// In-memory store
let profiles = [];

// Route per l'upload
app.post('/upload', upload.single('image'), (req, res) => {
  const { name, birthdate } = req.body;

  if (!req.file || !req.file.path) {
    return res.status(400).json({ error: 'Upload fallito' });
  }

  const newProfile = {
    imageUrl: req.file.path,
    name,
    birthdate
  };

  profiles.push(newProfile);
  res.status(200).json({ message: 'Upload riuscito', profile: newProfile });
});

// Route per recuperare i profili
app.get('/profiles', (req, res) => {
  res.json(profiles);
});

// Avvia il server
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
